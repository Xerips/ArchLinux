# Wazuh - Setting up and Kicking the tires

### Table of Contents

- [Why Wazuh?](https://github.com/Xerips/ArchLinux/tree/main/Defence!/Wazuh#why-wazuh)
- [Documentation Review](https://github.com/Xerips/ArchLinux/tree/main/Defence!/Wazuh#documentation-review)
- [Set'er up!](https://github.com/Xerips/ArchLinux/tree/main/Defence!/Wazuh#seter-up)
- [Kicking The Tires](https://github.com/Xerips/ArchLinux/tree/main/Defence!/Wazuh#kicking-the-tires)

### Why Wazuh?

- Wazuh is a great open source SIEM that has XDR capabilities. XDR stands for Extended Detection and Response which means it automatically correlates data across multiple security layers - Like email, endpoint, server, cloud, and networks.
- So XDR means that it includes multiple Detect and Respond capabilities including both Endpoint Detection and Response and Network Detection and Response
- It's open source! This means we can see the code and that there is a community supporting it. Anyone interested in participating with the project need only join the community. This is so cool!
- Free! It can be hard to learn some of the tools used in cyber security because so many come with costly yearly licensing fees. Finding the free or cheap options to practice your skills is incredibly valuable!
- It's well designed for small to mid-sized environments. That doesn't mean it isn't scalable, it just doesn't need scale to be useful.
  - You can scale Wazuh through clustering Agents.
- Built in alerting!
- Primarily used for security monitoring, threat detection, and compliance.
- A nice set of documentation for us to get started on their websites [Documentation Page](https://documentation.wazuh.com/current/index.html).

Why not E.L.K.(Elasticsearch, Logstash, Kibana)?

- Why not bring a monster truck to a soap box derby? Although ELK is powerful and widely used, it doesn't quite fit in with our system.
- No built in alerting. You'll need to plug in to other tools to have notifications and alerts.
- ELK is designed to handle massive amounts of data. There may be reasons for people to use ELK even though it doesn't fit their requirements, like practicing with it because you're looking for a job with a company that uses it. However, it's also important to understand what tool is right for the job. Just like a carpenter needs to know the difference between a framing hammer and a sledge, I think it is equally important for IT workers to understand their tools - so I'm trying to do that.
- I'll probably still play with this at some point because it is so ubiquitous and powerful.
- Primarily used for log analysis, operational monitoring, and gleaning insights from large data collection through visualization.
  - We might not be able to generate enough events to really see value from ELK.

### Documentation Review: "Getting Started"

When we start looking through the documentation we see that there are 4 components to Wazuh: Indexer, Server, Dashboard, and Agents. Here's what the docs say about each:

**Components:**

- [Indexer](https://documentation.wazuh.com/current/getting-started/components/wazuh-indexer.html): "The Wazuh indexer is a highly scalable, full-text search and analytics engine. This Wazuh central component indexes and stores alerts generated by the Wazuh server and provides near real-time data search and analytics capabilities. The Wazuh indexer can be configured as a single-node or multi-node cluster, providing scalability and high availability."
- [Server](https://documentation.wazuh.com/current/getting-started/components/wazuh-server.html): "The Wazuh server component analyzes the data received from the agents, triggering alerts when threats or anomalies are detected. It is also used to manage the agents configuration remotely and monitor their status." It also mentions how you can integrate ServiceNow, Jira, PagerDuty, and Slack, and how it enriches alert data with MITRE ATT&CK, PCI DSS, GDPR, CIS, and NIST 800-53 to provide context. Nice!
  - It also lets us know that it's typical to run the server on a standalone physical machine, VM, docker container, or cloud instance.
- [Dashboard](https://documentation.wazuh.com/current/getting-started/components/wazuh-dashboard.html): "The Wazuh dashboard is a flexible and intuitive web user interface for mining, analyzing, and visualizing security events and alerts data. It is also used for the management and monitoring of the Wazuh platform. Additionally, it provides features for role-based access control (RBAC) and single sign-on (SSO)."
  - There are some nice screenshots of the different dashboards here and some information about what's available through Wazuh dashboards.
- [Agents](https://documentation.wazuh.com/current/getting-started/components/wazuh-agent.html): "The Wazuh agent runs on Linux, Windows, macOS, Solaris, AIX, and other operating systems. It can be deployed to laptops, desktops, servers, cloud instances, containers, or virtual machines. The agent helps to protect your system by providing threat prevention, detection, and response capabilities. It is also used to collect different types of system and application data that it forwards to the Wazuh server through an encrypted and authenticated channel."
  - Agents are deployed with a modular architecture which allows you to enable or disable each module component to suit your needs. These are the different agent modules:
    - Log Collector
    - Command Execution
    - File Integrity Monitoring (FIM)
    - Security Configuration Assessment (SCA)
    - System Inventory
    - Malware Detection
    - Active Response
    - Container Security Monitoring
    - Cloud Security Monitoring
  - Agent-Server communication is done through a secure channel (TCP or UDP), and includes flow control mechanisms to avoid flooding, queueing events when necessary, and protecting the network bandwidth. It will play nice with our system and try not to eat up all our resources.

**Architecture:**

- The architecture is based on agents which run on monitored endpoints. These agents forward data to the Wazuh server to be digested.
- You can also collect data from agentless devices like Firewalls, Switches, Routers, and Access Points with Syslog, SSH, or their API.
- Once the data is collected and sent to the server, the service will decode and analyze the data and passes the results to the Wazuh indexer for, you guessed it, indexing and storage.
- Small deployments (that's us!) can easily be handled by a single-node cluster.
- You'll want multi-node clusters if any of the following apply to you: Many monitored endpoints, a large volume of data is anticipated, or when high availability is required.
- Production environments should deploy Wazuh server and Wazuh indexer to different hosts. This makes sense. You would want your server to be set up with the resources required to handle the traffic being sent to it. It's easier to do this reliably if you're setting up a host to handle this anticipated load, and nothing else. The Indexer needs things that the server doesn't, in particular storage. You'd hate to bog down your server with a bunch of read/write tasks while it's trying to handle incoming data from a large network of agents.
- Filebeat is used to securely forward Wazuh alerts and archived events to the Wazuh indexer using TLS encryption.

Here's a diagram:
![Wazuh Architecture]()

**Wazuh Agent-Server Communication:**

- The Wazuh agent continuously sends events to the Wazuh server. The agent establishes a connection with the server service, which listens on Port 1514 by default.
- Wazuh server decodes and rule-checks the received events with its analysis engine.
- Events that trip a rule are given rule ID and rule name and all events are sorted into the file `/var/ossec/logs/alerts/alerts.json`. All events, regardless of whether they trip a rule, are spooled into `/var/ossec/logs/archives/archives.json`.
- Wazuh message protocol uses AES encryption with 128 bits per block and 256-bit keys. Blowfish encryption is optional.

**Wazuh Server-Indexer Communication:**

- Filebeat reads the Wazuh server output data and send it to the indexer (listens on port 9200/TCP by default).
- Once indexed, the Wazuh dashboard mines and visualizes the information.
- Wazuh Dashoboard queries the Wazuh RESTful API (default 55000/TCP on Wazuh server) to display config and status-related info of the Wazuh Server and Agents.
- Can modify agents or server configuration through API calls.
- Authenticated with username:password and is TLS encrypted.

**Required Ports**
|Component|Port|Protocol|Purpose|
|---|---|---|---|
| Wazuh Server|1514|TCP (Default)|Agent Connection Service|
| |1514|UDP (Optional)|Agent Connection Service (Disabled by default)|
| |1515|TCP|Agent Enrollment Service|
| |1516|TCP|Wazuh Cluster Daemon|
| |514|UDP (Default)|Wazuh Syslog Collector (Disabled by Default)|
| |514|TCP (Optional)|Wasuh Syslog Collector (Disabled by Default)|
| |55000|TCP|Wazuh Server RESTful API
|Wazuh Indexer|9200|TCP|Wazuh Indexer RESTful API|
| |9300-9400|TCP|Wazuh Indexer Cluster Communication|
|Wazuh Dashboard|443|TCP|Wazuh Web User Interface|

**Archival Data Storage**

- Both alerts and non alerts are stored in files on the Wazuh server and can be stored in either `.json` or in plain text `.log` files.
- These files are compressed daily and signed using MD5, SHA1, and SHA256 checksums.
- See the directory and filename structure with: `root@wazuh-manager:/var/ossec/logs/archives/2024/Jan$ ls -la`
- This will return:
  `total 176
-rw-r----- 1 wazuh wazuh 234350 Jan  2 00:00 ossec-archive-01.json.gz
-rw-r----- 1 wazuh wazuh    350 Jan  2 00:00 ossec-archive-01.json.sum
-rw-r----- 1 wazuh wazuh 176221 Jan  2 00:00 ossec-archive-01.log.gz
-rw-r----- 1 wazuh wazuh    346 Jan  2 00:00 ossec-archive-01.log.sum
-rw-r----- 1 wazuh wazuh 224320 Jan  2 00:00 ossec-archive-02.json.gz
-rw-r----- 1 wazuh wazuh    350 Jan  2 00:00 ossec-archive-02.json.sum
-rw-r----- 1 wazuh wazuh 151642 Jan  2 00:00 ossec-archive-02.log.gz
-rw-r----- 1 wazuh wazuh    346 Jan  2 00:00 ossec-archive-02.log.sum
-rw-r----- 1 wazuh wazuh 315251 Jan  2 00:00 ossec-archive-03.json.gz
-rw-r----- 1 wazuh wazuh    350 Jan  2 00:00 ossec-archive-03.json.sum
-rw-r----- 1 wazuh wazuh 156296 Jan  2 00:00 ossec-archive-03.log.gz
-rw-r----- 1 wazuh wazuh    346 Jan  2 00:00 ossec-archive-03.log.sum`
- Wazuh recommends backups according to the storage capacity of the Wazuh server.
- Wazuh suggest using cron jobs to only keep a specified window of backups (3 months, 6 months, a year, depending on storage limitations)
- Last note: "you may choose to dispense with storing archive files and simply rely on the Wazuh indexer for archive storage. This alternative might be preferred if you run periodic Wazuh indexer snapshot backups and/or have a multi-node Wazuh indexer cluster with shard replicas for high availability. You could even use a cron job to move snapshotted indices to a final data storage server and sign them using MD5, SHA1, and SHA256 hashing algorithms."

**Use Cases**
This is a nice addition to the documentation. [Here](https://documentation.wazuh.com/current/getting-started/use-cases/index.html) you can look through the different use cases for Wazuh which will help with configuring the SIEM to your needs and specifications. We will use this in "Set'er up!" to get what we need out of it.
|Endpoint Security|Threat Intelligence|Security Operations|Cloud Security|
|---|---|---|---|
|[Configuration Assessment](https://documentation.wazuh.com/current/getting-started/use-cases/configuration-assessment.html)|[Threat Hunting](https://documentation.wazuh.com/current/getting-started/use-cases/threat-hunting.html)|[Incident Response](https://documentation.wazuh.com/current/getting-started/use-cases/incident-response.html)|[Container Security](https://documentation.wazuh.com/current/getting-started/use-cases/container-security.html)|
|[Malware Detection](https://documentation.wazuh.com/current/getting-started/use-cases/malware-detection.html)|[Log Data Analysis](https://documentation.wazuh.com/current/getting-started/use-cases/log-analysis.html)|[Regulatory Compliance](https://documentation.wazuh.com/current/getting-started/use-cases/regulatory-compliance.html)|[Posture Management](https://documentation.wazuh.com/current/getting-started/use-cases/posture-management.html)|
|[File Integrity Monitoring](https://documentation.wazuh.com/current/getting-started/use-cases/file-integrity.html)|[Vulnerability Detection](https://documentation.wazuh.com/current/getting-started/use-cases/vulnerability-detection.html)|[IT Hygiene](https://documentation.wazuh.com/current/getting-started/use-cases/it-hygiene.html)|[Workload Protection](https://documentation.wazuh.com/current/getting-started/use-cases/cloud-workload-protection.html)|

### Set'er up!

**Requirements:**

Hardware Requirements Based on Deploying Wazuh Server, Indexer, and Dashboard on the same host:
|Agents|CPU|RAM|Storage (90 days)|
|---|---|---|---|
|1-25|4 vCPUs|8 GiB|50 GB|
|25-50|8 vCPUs|8 GiB|100 GB|
|50-100|8 vCPUs|8 GiB|200 GB|

- Larger environments may require distributed deployments with Multi-node cluster configuration for server and indexer to provide high availability and load balancing.

**Recommended OS:** Red Hat Enterprise Linux 7, 8, 9 or Ubuntu 16.04, 18.04, 20.04, 22.04

**Browser Compatibility:** Chrome 95 or later, Firefox 93 or later, Safari 13.7 or later. Other Chromium-based browsers might also work.

**Installation:**

### Kicking The Tires
